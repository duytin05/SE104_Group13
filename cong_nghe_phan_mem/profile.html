<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Th√¥ng tin c√° nh√¢n</title>
  <style>
    body { font-family: Arial; padding: 30px; }
    h2 { text-align: center; }
    table { margin: auto; border-collapse: collapse; }
    td { padding: 8px 12px; }
    input { padding: 5px; width: 250px; }
    button { margin: 10px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h2>üë§ Th√¥ng tin c√° nh√¢n</h2>
  <table id="profileTable"></table>

  <div style="text-align:center;">
    <button onclick="enableEdit()"> S·ª≠a</button>
    <button onclick="saveProfile()"> L∆∞u</button>
  </div>

  <script>
    const token = localStorage.getItem("token");

    let userData = {};

    fetch("http://localhost:3001/api/profile", {
      headers: { Authorization: "Bearer " + token }
    })
    .then(res => res.json())
    .then(user => {
      userData = user;
      renderTable(user);
    })
    .catch(err => {
      alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√° nh√¢n");
      console.error(err);
    });

    function renderTable(user, editable = false) {
      const table = document.getElementById("profileTable");
      table.innerHTML = `
        <tr><td>H·ªç t√™n:</td><td><input id="name" value="${user.name || ""}" ${!editable ? "disabled" : ""}></td></tr>
        <tr><td>Gi·ªõi t√≠nh:</td><td>
          <select id="gender" ${!editable ? "disabled" : ""}>
            <option value="Nam" ${user.gender === "Nam" ? "selected" : ""}>Nam</option>
            <option value="N·ªØ" ${user.gender === "N·ªØ" ? "selected" : ""}>N·ªØ</option>
          </select>
        </td></tr>
        <tr><td>Ng√†y sinh:</td><td><input type="date" id="dob" value="${user.dob || ""}" ${!editable ? "disabled" : ""}></td></tr>
        <tr><td>Email:</td><td><input id="email" value="${user.email || ""}" ${!editable ? "disabled" : ""}></td></tr>
        <tr><td>SƒêT:</td><td><input id="phone" value="${user.phone || ""}" ${!editable ? "disabled" : ""}></td></tr>
        <tr><td>Ch·ª©c v·ª•:</td><td><input disabled value="${user.role}"></td></tr>
        <tr><td>T√†i kho·∫£n:</td><td><input disabled value="${user.username}"></td></tr>
      `;
    }

    function enableEdit() {
      renderTable(userData, true);
    }

    function saveProfile() {
      const updated = {
        name: document.getElementById("name").value,
        gender: document.getElementById("gender").value,
        dob: document.getElementById("dob").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
      };

      fetch("http://localhost:3001/api/profile", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify(updated)
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message || " C·∫≠p nh·∫≠t th√†nh c√¥ng!");
        userData = { ...userData, ...updated };
        renderTable(userData); // reload l·∫°i
      })
      .catch(err => {
        alert(" L·ªói khi c·∫≠p nh·∫≠t");
        console.error(err);
      });
    }
  </script>
</body>
</html>
